<style>
    @import url('https://fonts.googleapis.com/css?family=Roboto+Slab:100,300,400,700');
    @import url('https://fonts.googleapis.com/css?family=Raleway:300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i');

    .menuCon {
        /* height: auto; */
        position: absolute;
        top: 10px;
        right: 10px;
        height: 0px;
        width: 300px;
        background-color: rgb(30, 32, 33);
        border-radius: 20px;
        transition-duration: 200ms;
        max-height: calc(100% - 20px);
        overflow: hidden;
        z-index: 10;
    }

    .menuHeading,
    .menuItem {
        top: 0;
        width: 100%;
        color: white;
        font-family: 'Montserrat', sans-serif;
        font-weight: 400;
        box-sizing: border-box;
        padding: 20px;
        user-select: none;
        display: flex;
        align-items: center;
        justify-content: flex-start;
    }

    .menuItemToggle {
        display: flex;
        justify-content: space-between;
    }

    .menuHeading {
        text-align: left;
        background-color: rgb(30, 32, 33);
        position: sticky;
        z-index: 1;
    }

    .menuItem {
        text-align: left;
    }

    .menuItem.selected {
        background-color: white;
        color: black;
    }

    .menuItemValue {
        display: inline-block;
        color: #b8b8ba;
        vertical-align: middle;
        margin-left: auto;
        text-overflow: ellipsis;
        overflow: hidden;
        text-align: right;
        width: 100px;
        /* margin-left: 10px; */
    }
    

    .menuItemIcon {
        height: 30px;
        width: 30px;
        background-size: contain;
        background-position: center;
        background-repeat: no-repeat;
        vertical-align: middle;
        display: inline-block;
        margin-right: 20px;
    }

    .menuItemIconBack,
    .menuItemIconSub {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' height='24px' viewBox='0 0 24 24' width='24px' fill='%23ffffff'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M11.67 3.87L9.9 2.1 0 12l9.9 9.9 1.77-1.77L3.54 12z'/%3E%3C/svg%3E");
        height: 20px;
        width: 20px;
    }

    .menuItemIconSub {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' height='24px' viewBox='0 0 24 24' width='24px' fill='%23ffffff'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z'/%3E%3C/svg%3E");
        height: 30px;
        margin-right: 0;
        width: 30px;
    }

    .menuItemText {
        display: inline-block;
        margin-right: 10px;
        vertical-align: middle;
    }

    #qualIcon {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' height='24px' viewBox='0 0 24 24' width='24px' fill='%23ffffff'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-8 12H9.5v-2h-2v2H6V9h1.5v2.5h2V9H11v6zm2-6h4c.55 0 1 .45 1 1v4c0 .55-.45 1-1 1h-4V9zm1.5 4.5h2v-3h-2v3z'/%3E%3C/svg%3E");
    }

    #sourceIcon {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' enable-background='new 0 0 24 24' height='24px' viewBox='0 0 24 24' width='24px' fill='%23FFFFFF'%3E%3Cg%3E%3Crect fill='none' height='24' width='24'/%3E%3Cpath d='M20,6h-8l-2-2H4C2.9,4,2.01,4.9,2.01,6L2,18c0,1.1,0.9,2,2,2h16c1.1,0,2-0.9,2-2V8C22,6.9,21.1,6,20,6z M14,16H6v-2h8V16z M18,12H6v-2h12V12z'/%3E%3C/g%3E%3C/svg%3E");
    }

    #fillIcon {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' height='24px' viewBox='0 0 24 24' width='24px' fill='%23FFFFFF'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M19 12h-2v3h-3v2h5v-5zM7 9h3V7H5v5h2V9zm14-6H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16.01H3V4.99h18v14.02z'/%3E%3C/svg%3E");
    }

    #configIcon {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' enable-background='new 0 0 24 24' height='24px' viewBox='0 0 24 24' width='24px' fill='%23FFFFFF'%3E%3Cg%3E%3Cpath d='M0,0h24v24H0V0z' fill='none'/%3E%3Cpath d='M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z'/%3E%3C/g%3E%3C/svg%3E");
    }

    .scene {
        position: absolute;
        transition-duration: 0.2s;
        width: 100%;
        top: 0;
    }


    .textBox {
        appearance: none;
        border: 0;
        height: 40px;
        border-radius: 10px;
        width: 120px;
        margin: 10px;
        padding: 10px;
        outline: none;
        margin-bottom: 0px;
    }

    .toggle {
        display: inline-block;
        position: relative;
        height: 25px;
        min-width: 45px;
        cursor: pointer;
        border-radius: 25px;
        background-color: #fff;
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        margin-right: 10px;
        transition-duration: 200ms;
    }

    .toggle.active{
        background-color: #2196F3;
    }
    .toggle::before {
        content: "";
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        height: 15px;
        width: 15px;
        border-radius: 50%;
        background-color: #1a1a1a;
        border: 5px solid #fff;
        transition: all 0.2s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
    }

    .toggle.active::before {
        left: calc(100% - 25px);
        background-color: #fff;
        border-color: #2196F3;

    }

    .sceneCon {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow-y: auto;
        overflow-x: hidden;
        pointer-events: none;
        opacity: 0;
        left: 100%;
        transition-duration: 200ms;
    }

    .sceneCon.active {
        pointer-events: all;
        opacity: 1;
        left: 0px;
    }
</style>

<div class="menuCon"></div>

<script>

    function createElement(x) {
        let temp;
        if ("element" in x) {
            temp = document.createElement(x.element);

        } else {
            temp = document.createElement("div");

        }
        let attributes = x.attributes;

        for (value in attributes) {
            temp.setAttribute(value, attributes[value]);
        }



        for (value in x.style) {

            temp.style[value] = x.style[value];
        }


        if ("id" in x) {
            temp.id = x.id;
        }

        if ("class" in x) {
            temp.className = x.class;
        }

        if ("innerText" in x) {
            temp.textContent = x.innerText;
        }

        if ("innerHTML" in x) {
            temp.innerHTML = x.innerHTML;
        }

        let listeners = x.listeners;

        for (value in listeners) {
            temp.addEventListener(value, listeners[value]);
        }

        return temp;

    }



    let menuCon = document.querySelector(".menuCon");

    class Toggle {
        constructor(element) {
            this.element = element;
        }

        turnOn() {
            if (!this.isOn()) {
                this.element.click();
            }
        }

        turnOff() {
            if (this.isOn()) {
                this.element.click();
            }
        }

        isOn() {
            return this.element.classList.contains("active");
        }

        toggle() {
            if (this.isOn()) {
                this.turnOff();
            } else {
                this.turnOn();
            }
        }
    }

    class Selectables {
        constructor(element) {
            this.element = element;
        }

        select() {
            this.element.click();
        }
    }

    class Scene {
        constructor(config, dropDownMenuInstance) {
            this.data = config;
            this.DDMinstance = dropDownMenuInstance;
        }

        addItem(config, isHeading = false) {
            this.element.querySelector(".scene").append(this.DDMinstance.makeItem(config, isHeading, this.data.id));

            if (this.element.classList.contains("active")) {
                this.DDMinstance.menuCon.style.height = this.element.querySelector(".scene").offsetHeight + "px";
            }
        }

        delete() {
            this.deleteItems();
            this.data = null;
            this.DDMinstance = null;
            this.element.remove();
        }

        deleteItems() {
            this.element.querySelector(".scene").innerHTML = "";

            if (this.data.id in this.DDMinstance.selectedValues) {
                this.DDMinstance.selectedValues[this.data.id] = "";
            }

            this.DDMinstance.updateSelectVals(this.data.id);
            this.DDMinstance.deleteSceneFromHistory(this.data.id);

            for (let item of this.data.items) {
                this.DDMinstance.deleteItem(item);
            }
            this.data.items = [];
        }
    }

    class dropDownMenu {
        constructor(scenes, menuCon) {
            this.scenes = {};
            this.menuCon = menuCon;
            this.history = [];
            this.toggles = {};
            this.selections = {};
            this.selectedValues = {};
            this.selectedValuesDOM = {};
            for (let scene of scenes) {
                this.scenes[scene.id] = new Scene(scene, this);
            }

            for (let scene of scenes) {
                if (!this.scenes[scene.id].element) {
                    this.makeScene(scene);
                }
            }

            menuCon.onscroll = function () {
                menuCon.scrollLeft = 0;
            };



        }

        open(id) {
            if (id in this.scenes) {

                if (!this.history.length || (this.history.length && this.history[this.history.length - 1] != id)) {
                    this.history.push(id);
                }

                for (let sceneID in this.scenes) {
                    if (sceneID === id) {
                        this.scenes[sceneID].element.classList.add("active");
                        this.menuCon.style.height = this.scenes[sceneID].element.querySelector(".scene").offsetHeight + "px";
                    } else {
                        this.scenes[sceneID].element.classList.remove("active");
                    }
                }

            }
        }

        back() {
            if (this.history.length > 1) {
                let lastHistory = this.history.pop();
                this.open(this.history.pop());
            }else{
                this.closeMenu();
            }
        }


        openMenu(){
            this.menuCon.style.display = "block";
        }

        closeMenu(){
            this.menuCon.style.display = "none";
        }


        makeItem(item, isHeading = false, sceneID) {

            item.selectedValue = this.selectedValues[item.open];


            let shouldShowValue = false;
            if(this.scenes[item.open] instanceof Scene){
                shouldShowValue = this.scenes[item.open].data.selectableScene === true
            }


            let menuItem = createElement({
                "class": isHeading ? "menuHeading" : "menuItem",
                "attributes": item.attributes ? item.attributes : {},
            })

            if (!isHeading && "iconID" in item) {
                let menuItemIcon = createElement({
                    "class": "menuItemIcon",
                    "id": item.iconID
                });

                menuItem.append(menuItemIcon);
            }

            if (item.open) {
                menuItem.addEventListener("click", () => {
                    this.open(item.open);
                });
            }



            if (isHeading && item.hideArrow !== true) {
                let menuItemIcon = createElement({
                    "class": "menuItemIcon menuItemIconBack",
                });

                menuItem.addEventListener("click", () => {
                    this.back();
                });

                menuItem.append(menuItemIcon);
            }

            let self = this;

            if (item.callback) {
                menuItem.addEventListener("click", () => {
                    item.callback.bind(menuItem)();
                });
            }

            if (item.selected) {
                menuItem.classList.add("selected");
                if (sceneID) {
                    this.selectedValues[sceneID] = item.text;
                    this.updateSelectVals(sceneID);
                }
            }


            if (item.highlightable) {

                if (item.id) {
                    this.selections[item.id] = new Selectables(menuItem);
                }

                menuItem.setAttribute("highlightable", "true");
                menuItem.addEventListener("click", function () {
                    let siblings = menuItem.parentElement.children;

                    for (let child of siblings) {
                        if (child.getAttribute("highlightable") === "true") {
                            child.classList.remove("selected");
                        }
                    }

                    menuItem.classList.add("selected");

                    if (sceneID) {
                        self.selectedValues[sceneID] = menuItem.innerText;
                        self.updateSelectVals(sceneID);

                    }

                });
            }


            let menuItemText = createElement({
                "class": "menuItemText",
                "innerText": item.text
            });


            menuItem.append(menuItemText);

            if (item.textBox) {
                let textBox = createElement({
                    "element": "input",
                    "class": "textBox",
                    "attributes": {
                        "type": "text"
                    }
                });

                if (item.value) {
                    textBox.value = item.value;
                }
                textBox.addEventListener("input", item.onInput);

                // if(item.id){
                //     this.toggles[item.id] = new Toggle(toggle);
                // }
                menuItem.append(textBox);
            }


            if (shouldShowValue) {
                // menuItem.classList.add("menuItemToggle");

                let valueDOM = createElement({
                    "innerText": item.selectedValue,
                    "class": "menuItemValue"
                });
                menuItem.append(valueDOM);

                item.valueDOM = valueDOM;
                if (!this.selectedValuesDOM[item.open]) {
                    this.selectedValuesDOM[item.open] = {};
                }

                let sValue = this.selectedValuesDOM[item.open];


                if (sValue.elements) {
                    sValue.elements.push(valueDOM);
                } else {
                    sValue.elements = [valueDOM];
                }
            }


            if (item.open) {
                menuItem.append(createElement({
                    "class": "menuItemIcon menuItemIconSub",
                    "style": {
                        "marginLeft": item.selectedValue ? "3px" : "auto"
                    }
                }))
            }
            if (item.toggle) {
                menuItem.classList.add("menuItemToggle");
                let toggle = createElement({
                    "class": `toggle ${item.on ? " active" : ""}`,
                    "listeners": {
                        "click": function () {
                            this.classList.toggle("active");
                            if (this.classList.contains("active")) {
                                item.toggleOn();
                            } else {
                                item.toggleOff();
                            }
                        },
                    }
                });

                if (item.id) {
                    this.toggles[item.id] = new Toggle(toggle);
                }
                menuItem.append(toggle);
            }

            return menuItem;
        }

        updateSelectVals(sceneID) {
            if (this.selectedValuesDOM[sceneID]) {
                for (let elems of this.selectedValuesDOM[sceneID].elements) {
                    elems.innerText = this.selectedValues[sceneID];
                }
            }
        }
        makeScene(config) {
            let scene = createElement({
                "class": "scene"
            });

            let sceneCon = createElement({
                "class": "sceneCon"
            });


            let openScene = this.scenes[config.id];
            if (openScene.element) {
                return;
            }

            if(config.heading){
                scene.append(this.makeItem(config.heading, true, config.id));
            }
            for (let item of config.items) {
                if (item.open) {
                    let openScene = this.scenes[item.open];
                    if (!openScene.element && openScene.data.selectableScene) {
                        this.makeScene(this.scenes[item.open].data);
                    }
                }

                scene.append(this.makeItem(item, false, config.id));
            }

            sceneCon.append(scene);
            this.scenes[config.id].element = sceneCon;
            this.menuCon.append(sceneCon);

            return sceneCon;
        }

        addScene(config) {
            let sceneDIV = this.makeScene(config);
            this.menuCon.append(sceneDIV);
            config.element = sceneDIV;
            this.scenes[config.id] = config;
        }

        deleteScene(id) {
            if (id in this.scenes) {
                this.scenes[id].delete();
                delete this.scenes[id];
            }
        }

        deleteItem(item) {
            if (item.id in this.selections) {
                delete this.selections[item.id];
            }

            if (item.id in this.toggles) {
                delete this.toggles[item.id];
            }

            if (item.open) {
                let elem = this.selectedValuesDOM[item.open];
                if (elem) {
                    let elements = elem.elements;
                    let idx = elements.indexOf(item.valueDOM);
                    if (idx > -1) {
                        elements.splice(idx, 1);
                    }
                }
            }
        }

        deleteSceneFromHistory(val) {
            for (var i = this.history.length - 1; i >= 0; i--) {
                if (this.history[i] == val) {
                    this.history.splice(i, 1);
                }
            }
        }


        getToggle(id) {
            if (id in this.toggles) {
                return this.toggles[id];
            }

            return null;
        }

        getScene(id) {
            if (id in this.scenes) {
                return this.scenes[id];
            }

            return null;
        }
    }


    let DMenu = new dropDownMenu(
        [
            {
                "id": "initial",
                "items": [
                    {
                        "text": "Quality",
                        "iconID": "qualIcon",
                        "open": "quality",
                    },

                    {
                        "text": "Sources",
                        "iconID": "sourceIcon",
                        "open": "source"
                    },
                    {
                        "text": "Fill Mode",
                        "iconID": "fillIcon",
                        "open": "fillmode"
                    },
                    {
                        "text": "Config",
                        "iconID": "configIcon",
                        "open": "config"
                    }
                ]
            },
            {
                "id": "quality",
                "selectableScene": true,
                "heading": {
                    "text": "Quality",
                },
                "items": [
                    {
                        "text": "1080p",
                        "callback": () => console.log("1080p!"),
                        "highlightable": true,
                        "selected": true,
                    },
                    {
                        "text": "720p",
                        "callback": () => console.log("720p!"),
                        "highlightable": true,
                        "id": "720",
                    },
                    {
                        "text": "480p",
                        "callback": () => console.log("480p!"),
                        "highlightable": true,
                        "id": "480",
                    },
                    {
                        "text": "Auto",
                        "id": "auto",
                        "open": "initial"
                    }
                ]
            },

            {
                "id": "source",
                "selectableScene": true,
                "heading": {
                    "text": "Sources",
                },
                "items": [
                    {
                        "text": "HLS#sub",
                        "highlightable": true,
                        "selected": true,
                    },
                    {
                        "text": "HLS#dub",
                        "highlightable": true
                    }
                ]
            },

            {
                "id": "fillmode",
                "heading": {
                    "text": "Fill Mode",
                },
                "items": [
                    {
                        "text": "Normal",
                        "highlightable": true,
                        "selected": true,
                    },
                    {
                        "text": "Stretch",
                        "highlightable": true
                    },
                    {
                        "text": "Subtitles",
                        "highlightable": true
                    },
                    {
                        "text": "Fill",
                        "open": "quality"
                        // "highlightable": true
                    }
                ]
            },

            {
                "id": "config",
                "heading": {
                    "text": "Configuration",
                    "back": true
                },
                "items": [

                    {
                        "text": "Fill Mode",
                        "iconID": "fillIcon",
                        "open": "fillmode"
                    },
                    {
                        "text": "Autoplay",
                        "toggle": true,
                        "toggleOn": () => console.log("Toggle on"),
                        "toggleOff": () => console.log("Toggle off"),
                    },
                    {
                        "text": "Rewatch Mode",
                        "toggle": true,
                        "toggleOn": () => console.log("Toggle on"),
                        "toggleOff": () => console.log("Toggle off"),
                    },
                    {
                        "text": "Hide Skip Intro",
                        "toggle": true,
                        "toggleOn": () => console.log("Toggle on"),
                        "toggleOff": () => console.log("Toggle off"),
                    },
                    {
                        "text": "Automatically Skip Intro",
                        "toggle": true,
                        "toggleOn": () => console.log("Toggle on"),
                        "toggleOff": () => console.log("Toggle off"),
                    },
                    {
                        "text": "Double Tap Time",
                        "textBox": true,
                        "onInput": function (value) {
                            console.log(value.target.value);
                        }
                    },
                    {
                        "text": "Skip Tutton Time",
                        "textBox": true,
                        "value": "hi",
                        "onInput": function (value) {
                            console.log(value.target.value);
                        }
                    }
                ]
            }
        ], menuCon);


    DMenu.open("initial");

</script>
